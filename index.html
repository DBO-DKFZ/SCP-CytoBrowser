<!DOCTYPE html>
<html>

<head>
    <title>TissUUmaps</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <script src="js/d3.v4.min.js"></script>
    <script src="js/d3-scale-chromatic.v0.3.min.js"></script>
    <script src="js/jquery-3.4.1.slim.min.js"></script>
    <link rel="stylesheet" href="css/tmcpmain.min.css">
    <link rel="stylesheet" href="css/TissueMapsTheme.css">
    <link rel="stylesheet" href="css/tm-icon-style.css">
</head>

<body>
    <div class="navbar navbar-default">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-responsive-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://tissuumaps.research.it.uu.se/"><img
                style="height:50px; margin-top:-15px; overflow: visible; z-index: 9999;"
                src="misc/uulogowhitetuum.png"> </a>
        </div>
        <div class="navbar-collapse collapse navbar-responsive-collapse">
            <ul class="nav navbar-nav">
                <li>
                    <a id="project_title" href "#"> Slide A</a>
                </li>
            </ul>
            <!-- Show ImageName, Z-level, and Zoom-->
            <ul class="nav navbar-nav">
				<li class="nav-item"><a>Image: <span id="img_name"> -</span></a></li>
                <li class="nav-item"><a> Z-level: <span id="img_zlevel"> -</span></a></li>
                <li class="nav-item"><a> Zoom: <span id="img_zoom"> -</span></a></li>
			</ul>
        </div>
    </div>

    <div class="container-fluid">

        <!-- The main viewer -->
        <div class="col-xs-8"> <!-- Each class scales up, so if you wish to set the same widths for xs and sm, you only need to specify xs. -->
            <!-- The id is what OSD will look for to draw the viewer, the class is our own css to stylize
                 The ID will give the prefix for all the objects related to the viewer in this case ISS-->
            <div id="ISS_viewer" class="ISS_viewer"></div>
        </div>

        <!-- Table of annotated points -->
        <div class="col-xs-4">
            <div class="row">
                <div class="table-wrapper-scroll-y my-custom-scrollbar">
                <table id="tmcptable" class="table-striped table-bordered table-hover" style="padding: 10px; width: 100%; text-align: center;" >
                    <col width="10%"><col width="70%"> <col width="30%">
                    <thead align="center" >
                        <tr align="center" >
                            <th class="text-center" >ID</th>
                            <th class="text-center" id="thimg1">Annotation</th>
                        </tr>
                    </thead>

                    <tbody id="tmcptablebody">
                    </tbody>
                </table>
                </div>
            </div>
        </div>

        <!-- Interface buttons -->
        <div class="col-xs-4">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Options</h3>
                </div>
                <div class="panel-body">
                    <div class="row" style="padding: 0 10px 10px">
                        <div class="col-xs-9">
                            <h5>Marker class:</h5>
                            <div id="class_buttons" class="btn-group btn-group-small btn-group-toggle" data-toggle="buttons" style="display: flex">
                                <!-- Buttons are added programatically -->
                            </div>
                        </div>
                        <div class="col-xs-3">
                            <h5>Focus:</h5>
                            <button id="focus_next" class="btn btn-primary" type="button"> Up</button>
                            <button id="focus_prev" class="btn btn-primary" type="button"> Down</button>
                        </div>
                    </div>

                    <!-- Download annotation json -->
                    <div class="row" style="padding: 10px">
                        <div class="col-xs-3">
                            <button id="pointstojson" class="btn btn-primary btn-block" type="button"> Download</button>
                        </div>
                        <div class="col-xs-6">
                            <input class="form-control-file form-control form-control-sm" type="file" id="data_files_import" name="files[]">
                        </div>
                        <div class="col-xs-3">
                                <input type="file" id="fileElem" multiple accept="image/*" style="display:none" onchange="handleFiles(this.files)">
                            <button id="jsontodata" class="btn btn-primary btn-block" type="button"> Import </button>
                        </div>
                    </div>
                    <div class="row" style="padding: 15px">
                        <textarea class="form-control" rows="10" id="jsonpoints"></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div><!-- end of container-fuild-->

    <!-- Button trigger modal -->
    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#exampleModal">
      Launch demo modal
    </button>

    <!-- Modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            ...
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary">Save changes</button>
          </div>
        </div>
      </div>
    </div>
</body>

<script src="js/bootstrap.4.0.0.bundle.min.js" ></script>
<script src="js/openseadragon.2.4.0.min.js"></script>
<script src="js/openseadragon-filtering.js"></script>
<script src="js/openseadragon-svg-overlay.js"></script>
<!-- <script src="js/tm_utils/interfaceUtils.js"></script> -->
<!-- <script src="js/tm_utils/dataUtils.js"></script> -->
<!-- <script src="js/tm_utils/CPDataUtils.js"></script> -->
<!-- <script src="js/tm_utils/markerUtils.js"></script> -->
<script src="js/tm_utils/OSDViewerUtils.js"></script>
<!-- <script src="js/tm_utils/HTMLElementUtils.js"></script> -->
<!-- <script src="js/tm_utils/regionUtils.js"></script> -->
<!-- <script src="js/tm_utils/overlayUtils.js"></script> -->
<!-- <script src="js/tm_utils/geometryUtils.js"></script> -->
<script src="js/utils/bethesdaClassUtils.js"></script>
<script src="js/utils/JSONUtils.js"></script>
<script src="js/utils/overlayUtils.js"></script>
<script src="js/utils/markerUtils.js"></script>
<script src="js/markerPoints.js"></script>
<script src="js/tmapp.js"></script>
<script>
    markerUtils._TMCPStyle={ strokeWidth: 4, radius: 80, drawText:false, textSize:1 };

    document.getElementById("project_title").innerText = "Cyto Browser";

    // Populate the class buttons programatically
    bethesdaClassUtils.forEachClass(function(item, index){
        let label = $("<label></label>");
        label.addClass("btn btn-success");
        if (index == 0) { label.addClass("active"); }
        label.attr("id", "class_" + item.name);
        label.attr("title", item.description);
        label.css("flex", 1);
        let input = $("<input>" + item.name + "</input>");
        input.attr("type", "radio");
        input.attr("name", "class_options");
        input.attr("autocomplete", "off");
        label.append(input);
        $("#class_buttons").append(label);
    });

    // Start our tmapp
    $(document).ready(function () {
        var url = new URL(window.location.href);
        tmapp.fixed_file = url.searchParams.get("image"); //TODO: Give sensible error message if "image" key is missing
//        tmapp.registerActions();

        // Get the viewport params from the URL
        const initial_params = {
            zoom: url.searchParams.get("zoom"),
            x: url.searchParams.get("x"),
            y: url.searchParams.get("y"),
            z: url.searchParams.get("z")
        };
        // Check if all params are present
        const values = Object.values(initial_params);
        const params_defined = values.every(value => value != null);

        // Set the initial params if all are defined
        if (params_defined) {
            // Convert to numbers first
    	    for (const [key, value] of Object.entries(initial_params)) {
                    initial_params[key] = Number(value);
    	    }
            tmapp.initial_params = initial_params;
        }
        tmapp.init();
    });

    // UI setters
    function setImageName(txt) {
        document.getElementById("img_name").innerText=txt;
    }
    function setImageZLevel(txt) {
        document.getElementById("img_zlevel").innerText=txt;
    }
    function setImageZoom(txt) {
        document.getElementById("img_zoom").innerText=txt;
    }
    function setURL(txt) {
        window.history.pushState(null, "", txt);
    }

    $(document).mousedown(function(event){
        if (!(document.hasFocus())) {
            console.log("Lost focus, ignoreing click and setting focus")
            tmcpoints.fixed_viewer.canvas.focus();
        }
    });

    //1,2,... for class selection
    //z,x for focus up down
    $(document).keypress(function(){
        console.log(event.which);
        switch(event.which) {
            case "z".charCodeAt(): document.getElementById("focus_prev").click(); break;
            case "x".charCodeAt(): document.getElementById("focus_next").click(); break;
            default:
                // Handle digit keys being pressed for classes
                const digits = Array.from({length: 10}, (v,k) => String((k+1) % 10));
                const chars = digits.map((digit) => digit.charCodeAt());
                chars.slice(0, bethesdaClassUtils.amountClasses).forEach((char, index) => {
                    if (event.which == char) {
                        $("#class_" + bethesdaClassUtils.getClassFromID(index).name).click();
                    }
                });
        }
    });
</script>
</html>
